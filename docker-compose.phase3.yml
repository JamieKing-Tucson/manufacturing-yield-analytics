services:
  iceberg-rest:
    image: tabulario/iceberg-rest:latest
    container_name: iceberg-rest
    user: "0:0"

    environment:
      # MinIO creds
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin123
      AWS_REGION: us-east-1
      AWS_DEFAULT_REGION: us-east-1
      AWS_EC2_METADATA_DISABLED: "true"
      AWS_S3_FORCE_PATH_STYLE: "true"

      # Force PATH-STYLE (avoid warehouse.minio hostnames)
      JAVA_TOOL_OPTIONS: "-Daws.s3.pathStyleAccess=true"
      JAVA_OPTS: "-Daws.s3.pathStyleAccess=true"

      # Iceberg must use S3FileIO
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO

      # S3 endpoint + behavior
      CATALOG_S3_ENDPOINT: http://minio:9000
      CATALOG_S3_PATH_STYLE_ACCESS: "true"
      CATALOG_S3_FORCE_PATH_STYLE: "true"
      CATALOG_S3_SSL_ENABLED: "false"
      CATALOG_S3_REGION: us-east-1
      
      # Warehouse bucket (bucket name is "warehouse")
      CATALOG_WAREHOUSE: s3://warehouse/
      
      # JDBC catalog (SQLite)
      CATALOG_CATALOG__IMPL: org.apache.iceberg.jdbc.JdbcCatalog
      CATALOG_URI: jdbc:sqlite:file:/var/lib/iceberg/iceberg.db
      CATALOG_JDBC_USER: user
      CATALOG_JDBC_PASSWORD: password
      CATALOG_JDBC_SCHEMA_VERSION: V1
    
    volumes:
      - site-a_iceberg-rest-db:/var/lib/iceberg
    restart: unless-stopped
    ports:
      - "8181:8181"
    networks:
      - itar-core
              
    depends_on:
      - minio

  trino:
    image: trinodb/trino:latest
    container_name: trino
    
    restart: unless-stopped
    ports:
      - "18080:8080"

    volumes:
      - ./phase3/trino/catalog:/etc/trino/catalog:ro

    networks:
      - itar-core
          
    depends_on:
      - iceberg-rest
      - minio

volumes:
  site-a_iceberg-rest-db:

networks:
  itar-core:
    external: true
    name: core-platform_itar-core